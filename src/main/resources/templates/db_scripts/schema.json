{
  "tables": [
    {
      "tableName": "note_data",
      "fromModuleVersion": 0.2,
      "withMetadata": true,
      "generateId": true,
      "populateJsonWithId": true,
      "likeIndex": [
        {
          "fieldName": "title",
          "tOps": "ADD",
          "caseSensitive": false
        }
      ]
    },
    {
      "tableName": "note_type",
      "generateId": true,
      "fromModuleVersion": 1.0,
      "withMetadata": true,
      "populateJsonWithId": true,
      "uniqueIndex" : [
        {
          "fieldName" : "name",
          "tOps" : "ADD"
        }
      ],
      "likeIndex": [
        {
          "fieldName": "name",
          "tOps": "ADD",
          "caseSensitive": false
        }
      ]
    }
  ],
  "scripts": [
    {
      "run": "after",
      "snippet": "ALTER TABLE note_data ADD COLUMN temporary_type_id UUID REFERENCES note_type (id);CREATE OR REPLACE FUNCTION update_type_id()RETURNS TRIGGER AS $$BEGIN  NEW.temporary_type_id = NEW.jsonb->>'typeId';  RETURN NEW;END;$$ language 'plpgsql'; CREATE TRIGGER update_type_id  BEFORE INSERT OR UPDATE ON note_data  FOR EACH ROW EXECUTE PROCEDURE update_type_id();",
      "fromModuleVersion": "1.0"
    },
    {
      "run": "after",
      "snippet": "CREATE OR REPLACE VIEW note_view AS SELECT note_data.id, jsonb_build_object( 'id', note_data.jsonb->>'id',  'title', note_data.jsonb->>'title',  'content', note_data.jsonb->>'content',  'creator', note_data.jsonb->'creator',  'updater', note_data.jsonb->'updater',  'links', note_data.jsonb->'links',  'linkDomains',  (SELECT array_agg(DISTINCT domain) FROM jsonb_to_recordset(note_data.jsonb->'links') AS x(domain text)),  'linkTypes',  (SELECT array_agg(DISTINCT type) FROM jsonb_to_recordset(note_data.jsonb->'links') AS x(type text)),  'linkIds',  (SELECT array_agg(DISTINCT id) FROM jsonb_to_recordset(note_data.jsonb->'links') AS x(id text)), 'metadata', note_data.jsonb->'metadata',  'typeId', note_type.jsonb->'id', 'type', note_type.jsonb->'name') AS jsonb FROM note_data LEFT JOIN note_type ON note_data.jsonb->>'typeId' = note_type.jsonb->>'id';",
      "fromModuleVersion": "1.0"
    }
  ]
}
