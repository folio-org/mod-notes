# Full application stack for mod-notes (infrastructure + module)
# This includes all infrastructure services and the mod-notes module itself

include:
  - infra-docker-compose.yml

services:
  mod-notes:
    image: dev.folio/mod-notes:latest
    build:
      context: ../
      dockerfile: Dockerfile
    ports:
      - "${MODULE_PORT}:8081"
      - "${DEBUG_PORT}:5005"
    environment:
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      OKAPI_URL: ${OKAPI_URL}
      JAVA_OPTIONS: "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005"
    networks:
      - mod-notes-local
    depends_on:
      - postgres
      - wiremock
    deploy:
      replicas: ${MODULE_REPLICAS:-1}
      restart_policy:
        condition: on-failure
      update_config:
        parallelism: 1
        delay: 10s
      resources:
        limits:
          cpus: "1.0"
          memory: "512M"
        reservations:
          cpus: "0.5"
          memory: "256M"

